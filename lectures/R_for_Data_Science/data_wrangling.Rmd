---
title: "Data Wrangling"
output: html_document
---

## Data Wrangling

In the real world, data science projects rarely involve data that can be easily imported ready for analysis. According to Wikipedia:

>Data munging or data wrangling is loosely the process of manually converting or mapping data from one "raw" form into another format that allows for more convenient consumption of the data with the help of semi-automated tools.

Our example dataset provides an example:

```{r}
url <- "https://raw.githubusercontent.com/datasciencelabs/2016_data/master/bio260_heights.csv"
dat <- read.csv(url)
```

First note how we make assignments in R: we use `<-`. We can also use the equal sign `=` although here we try to stick to `<-` to make it very clear it is an assignment and not logical statement.

We also note that we have put the content of what comes out of `read.csv` into an _object_. We picked the object name `dat`. 

So what is `dat` exactly? We can get a quick summary of what an object is with the function `str` (stands for structure)

```{r}
str(dat)
```

Here we see that this object is a `data.frame`. These are one of the most widely used data types in R. They are particularly useful for storing tables. 

To see more of this object we can type it 


Now we want to describe the heights. We could simply report the list of numbers. But there is a problem. Take a look at the entries:
```{r,eval=FALSE}
View(dat)
```

Notice these not all entries are numbers. Furthermore, they are not all in inches. So what to do? We need to wrangle

#### Extracting columns

To extract columns from the data.frame we use the `$` character like this:

```{r, eval=FALSE}
dat$Timestamp
```

This now gives us a vector. We can access elements of the vector using the `[` symbol:

```{r}
dat$Timestamp[2]
```

#### Quick Review of Vectors

The following simple function may come in handy

```{r}
x <- c(1,2,3,4,5)
y <- 1:5
z <- seq(1,5)
```



## Data Manipulation wiht `dplyr`

R provides incredibly powerful and flexible language for data manipulation. However, the syntax is somewhat hard to get used to. We will therefore  introducing a package that makes the syntax much more like the English language. This package is `dplyr` which you should install if you have not done so already.

```{r, message=FALSE}
library(dplyr)
```

When using `dplyr` we recommend reading in data with the functions in the `readr` package:

```{r}
library(readr)
dat <- read_csv("https://raw.githubusercontent.com/datasciencelabs/2016_data/master/bio260_heights.csv")
```

This object is now a special type of `data.frame` called `tbl_df` that has a nicer printing method. We can now simply evaluate an expression with just the object and see a meaningful summary instead of 
everything.

```{r}
dat
```

#### Selecting columns

Right, we are interested in looking at heights. We can select just that column using:

```{r}
select(dat, contains("height"))
```

We have a problem: this is a `character`. We want numbers. 

## Renaming columns

Before we continue it will be convenient to change the names of our columns to something more convenient.

```{r}
names(dat) <- c("time","gender","height")
```

## Vectorization

```{r}
h <- dat$height
h[3]
as.numeric(h[3])
```

One powerful feature of R is that we can _vectorize_
most operation

```{r}
 as.numeric(h) 
```

## Missing values

Note in the the `NA` value in the object above. 

These are missing values. We can find out which values are missing using the function 

```{r,eval=FALSE}
?is.na
```

## Adding columns
```{r}
dat <- mutate(dat, numeric_height=as.numeric(height),
              original=height)
```

## Subsetting Observations

To see all the row in which we have problems:

```{r}
filter(dat, is.na(numeric_height))
```

## The Pipe

```{r}
filter(dat, is.na(numeric_height)) %>% select(height) 
```

Let's see more

```{r}
filter(dat, is.na(numeric_height)) %>% select(height) %>% print(n=21)
```


Let's get rid of `"`

```{r}
dat <- mutate(dat, height= gsub("ft","'",height) )
dat <- mutate(dat, height= gsub("\"|inches|\ ","",height) )
```

```{r}
filter(dat, is.na(numeric_height)) %>% select(height) %>% print(n=21)
```


## Functions 

```{r}
fixheight <- function(x){
  y <- strsplit(x, "'")
  ret <- sapply(y, function(z){
    ifelse( length(z)>1, as.numeric(z[1])*12 + as.numeric(z[2]) ,
            as.numeric(z[1]))
  })
  return(ret)
}
```

We can now test the function
```{r}
fixheight( "70")
fixheight( "5'10")
fixheight( "5'10")
fixheight( c("5'9","70","5'11"))
```


```{r}
dat <- mutate(dat, height=fixheight(height)) %>% select(-numeric_height)
```
